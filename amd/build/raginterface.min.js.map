{"version":3,"file":"raginterface.min.js","sources":["../src/raginterface.js"],"sourcesContent":["/* eslint-disable */\n// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * JavaScript for Terus RAG block.\n *\n * @module     block_terusrag/raginterface\n  * @copyright  2025 Khairu Aqsara <khairu@teruselearning.co.uk>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['core/ajax', 'core/notification', 'core/str'],\n    function(Ajax, Notification, Str) {\n    'use strict';\n\n    /**\n     * Module level variables.\n     */\n    var RAGInterface = {};\n    var SELECTORS = {\n        COMPONENT: '.block_terusrag',\n        FORM: '.rag-form',\n        QUERY_INPUT: '[data-region=\"query-input\"]',\n        SUBMIT_BUTTON: '[data-action=\"submit-query\"]',\n        RESPONSE_AREA: '[data-region=\"response-area\"]',\n        RESPONSE_CONTENT: '[data-region=\"response-content\"]',\n        RESPONSE_TEXT: '[data-region=\"response-text\"]',\n        RESPONSE_METADATA: '[data-region=\"response-metadata\"]',\n        LOADING_INDICATOR: '[data-region=\"loading-indicator\"]',\n        PLACEHOLDER: '[data-region=\"placeholder\"]'\n    };\n\n    /**\n     * Initialize the module.\n     *\n     * @param {string} selector The CSS selector for the RAG block\n     */\n    RAGInterface.init = function(selector) {\n        const container = document.querySelector(selector);\n        if (!container) {\n            return;\n        }\n\n        const form = container.querySelector(SELECTORS.FORM);\n        \n\n        form.addEventListener('submit', function(e) {\n            e.preventDefault();\n            const query = container.querySelector(SELECTORS.QUERY_INPUT).value.trim();\n            if (query) {\n                RAGInterface.submitQuery(container, query);\n            }\n        });\n    };\n\n    /**\n     * Submit a query to the RAG system.\n     *\n     * @param {Element} container The RAG block container element\n     * @param {string} query The user's query\n     */\n    RAGInterface.submitQuery = function(container, query) {\n        const courseId = container.dataset.courseid;\n        const loadingIndicator = container.querySelector(SELECTORS.LOADING_INDICATOR);\n        const responseContent = container.querySelector(SELECTORS.RESPONSE_CONTENT);\n        const responseText = container.querySelector(SELECTORS.RESPONSE_TEXT);\n        const responseMetadata = container.querySelector(SELECTORS.RESPONSE_METADATA);\n        // Store a direct reference to the input field\n        const queryInputField = container.querySelector(SELECTORS.QUERY_INPUT);\n        const contentPlaceholder = container.querySelector(SELECTORS.PLACEHOLDER);\n\n        // Debug log\n        console.log('Query input found:', queryInputField);\n\n        // Show loading indicator\n        loadingIndicator.classList.remove('hidden');\n        contentPlaceholder.classList.add('hidden');\n        // Clear previous results\n        responseText.textContent = '';\n        responseMetadata.textContent = '';\n        responseContent.classList.remove('hidden');\n\n        // Make AJAX call\n        Ajax.call([{\n            methodname: 'block_terusrag_submit_query',\n            args: {\n                query: query,\n                courseid: courseId\n            },\n            done: function(response) {\n                // Clear the input field after successful submission\n                if (queryInputField) {\n                    queryInputField.value = '';\n                    console.log('Input field cleared');\n                } else {\n                    console.error('Query input field not found for clearing');\n                }\n                \n                loadingIndicator.classList.add('hidden');\n                // Check if answer exists and is an array\n                if (response.answer && Array.isArray(response.answer)) {\n                    // Display response with proper structure\n                    responseText.innerHTML = response.answer.map(function(item) {\n                        let content = `\n                            <div class=\"rag-response-item mb-3\">\n                                <h4 class=\"rag-response-title\">\n                                    <a href=\"${item.viewurl}\" target=\"_blank\">${item.title}</a>\n                                </h4>\n                                <div class=\"rag-response-content\" data-content-id=\"${item.id}\">\n                                    ${item.content}\n                                </div>\n                            </div>\n                        `;\n                        return content;\n                    }).join('');\n                } else {\n                    responseText.innerHTML = '<p>'+Str.get_string('noresultsfound', 'block_terusrag')+'</p>';\n                }\n\n                // Show metadata\n                responseMetadata.classList.remove('hidden'); // Ensure metadata container is visible\n                \n                // Format and display token usage information\n                if (response.promptTokenCount !== undefined && \n                    response.responseTokenCount !== undefined && \n                    response.totalTokenCount !== undefined) {\n                    \n                    Str.get_string('token_usage', 'block_terusrag', {\n                        prompt: response.promptTokenCount,\n                        response: response.responseTokenCount,\n                        total: response.totalTokenCount\n                    }).then(function(str) {\n                        responseMetadata.innerHTML = str;\n                        return;\n                    }).catch(Notification.exception);\n                } else {\n                    responseMetadata.innerHTML = '<div class=\"token-info\">'+Str.get_string('notokeninformation', 'block_terusrag')+'</div>';\n                }\n            },\n            fail: function(error) {\n                console.error('Query submission failed:', error);\n                Notification.exception(error);\n            }\n        }]);\n    };\n\n    return RAGInterface;\n});\n"],"names":["define","Ajax","Notification","Str","RAGInterface","SELECTORS","init","selector","container","document","querySelector","addEventListener","e","preventDefault","query","value","trim","submitQuery","courseId","dataset","courseid","loadingIndicator","responseContent","responseText","responseMetadata","queryInputField","contentPlaceholder","console","log","classList","remove","add","textContent","call","methodname","args","done","response","error","answer","Array","isArray","innerHTML","map","item","viewurl","title","id","content","join","get_string","undefined","promptTokenCount","responseTokenCount","totalTokenCount","prompt","total","then","str","catch","exception","fail"],"mappings":";;;;;;;AAwBAA,qCAAO,CAAC,YAAa,oBAAqB,aACtC,SAASC,KAAMC,aAAcC,SAMzBC,aAAe,GACfC,eAEM,YAFNA,sBAGa,8BAHbA,2BAMkB,mCANlBA,wBAOe,gCAPfA,4BAQmB,oCARnBA,4BASmB,oCATnBA,sBAUa,qCAQjBD,aAAaE,KAAO,SAASC,gBACnBC,UAAYC,SAASC,cAAcH,cACpCC,iBAIQA,UAAUE,cAAcL,gBAGhCM,iBAAiB,UAAU,SAASC,GACrCA,EAAEC,uBACIC,MAAQN,UAAUE,cAAcL,uBAAuBU,MAAMC,OAC/DF,OACAV,aAAaa,YAAYT,UAAWM,WAWhDV,aAAaa,YAAc,SAAST,UAAWM,aACrCI,SAAWV,UAAUW,QAAQC,SAC7BC,iBAAmBb,UAAUE,cAAcL,6BAC3CiB,gBAAkBd,UAAUE,cAAcL,4BAC1CkB,aAAef,UAAUE,cAAcL,yBACvCmB,iBAAmBhB,UAAUE,cAAcL,6BAE3CoB,gBAAkBjB,UAAUE,cAAcL,uBAC1CqB,mBAAqBlB,UAAUE,cAAcL,uBAGnDsB,QAAQC,IAAI,qBAAsBH,iBAGlCJ,iBAAiBQ,UAAUC,OAAO,UAClCJ,mBAAmBG,UAAUE,IAAI,UAEjCR,aAAaS,YAAc,GAC3BR,iBAAiBQ,YAAc,GAC/BV,gBAAgBO,UAAUC,OAAO,UAGjC7B,KAAKgC,KAAK,CAAC,CACPC,WAAY,8BACZC,KAAM,CACFrB,MAAOA,MACPM,SAAUF,UAEdkB,KAAM,SAASC,UAEPZ,iBACAA,gBAAgBV,MAAQ,GACxBY,QAAQC,IAAI,wBAEZD,QAAQW,MAAM,4CAGlBjB,iBAAiBQ,UAAUE,IAAI,UAE3BM,SAASE,QAAUC,MAAMC,QAAQJ,SAASE,QAE1ChB,aAAamB,UAAYL,SAASE,OAAOI,KAAI,SAASC,wMAI3BA,KAAKC,qCAA4BD,KAAKE,iJAEAF,KAAKG,sDACpDH,KAAKI,qHAKpBC,KAAK,IAER1B,aAAamB,UAAY,MAAMvC,IAAI+C,WAAW,iBAAkB,kBAAkB,OAItF1B,iBAAiBK,UAAUC,OAAO,eAGAqB,IAA9Bd,SAASe,uBACuBD,IAAhCd,SAASgB,yBACoBF,IAA7Bd,SAASiB,gBAETnD,IAAI+C,WAAW,cAAe,iBAAkB,CAC5CK,OAAQlB,SAASe,iBACjBf,SAAUA,SAASgB,mBACnBG,MAAOnB,SAASiB,kBACjBG,MAAK,SAASC,KACblC,iBAAiBkB,UAAYgB,OAE9BC,MAAMzD,aAAa0D,WAEtBpC,iBAAiBkB,UAAY,2BAA2BvC,IAAI+C,WAAW,qBAAsB,kBAAkB,UAGvHW,KAAM,SAASvB,OACXX,QAAQW,MAAM,2BAA4BA,OAC1CpC,aAAa0D,UAAUtB,YAK5BlC"}